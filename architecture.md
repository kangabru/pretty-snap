# Architecture

Pretty Snap comprises of two standalone apps:
- Pretty Background - adds pretty background patterns or images to screenshots
- Pretty Annotate  - annotate screenshots with text and diagrams

---

## Tech Stack

### Libraries

Core libs | Usage
| - | - |
[Preact](https://preactjs.com/) | Equivalent to React but much smaller. This is the core library used to render the page and add interactivity.
[Typescript](https://www.typescriptlang.org/) | Adds types to javascript which helps reduce bugs and improve maintainability.
[Tailwind CSS](https://tailwindcss.com/) | Utility CSS class library which allows us to define styles on html elements directly.
[Parcel JS](https://parceljs.org/getting_started.html) | Used to bundle Preact, Tailwind, and other libs into a usable static website.

Extra libs | Usage
| - | - |
[Zustand](https://github.com/pmndrs/zustand) | Nice to use state management within preact components.
[DOM to image](https://github.com/tsayen/dom-to-image/) | Used to export and download images generated by the Pretty Snap apps.
[React Spring](https://www.react-spring.io/) | Used for spring physics animations.

---

### APIs

Some external APIs are used within the app. While useful, these APIs are only optional and are not critical to running the apps.

API | Usage
| - | - |
Plausible | A privacy conscious analytics library
Unsplash | Used to import image backgrounds in the Pretty Background app. This is hosted via serverless functions using Cloudflare Workers.

---

### Deployment

The core app is bundled into a static site meaning deployment is a simple act of hosting the files on a CDN. Netlify or an equivalent service can be used to host this cheaply and easily.

To use the optional Unsplash API we need to sign requests with an API key. This *does* require the use of a server which is done via serverless functions with Cloudflare Workers.
- Cloudflare workers are simple functions that can route/transform HTTP requests
- Worker calls are fast, cheap, and are easily tested/deployed via their online editor
- Workers can route requests at the DNS level:
    - For example requests to `api/` are routed to the worker while everything else routes to the CDN.
    - Because the worker runs at the DNS level, the `api/` call comes from the same domain as the hosted site which eliminates CORS issues.

See how to actually deploy the site via the [readme](readme.md).

---

## Concepts and Features

### Structure

Here are common folder names and what's inside them.

Common folder | Usage
| :-: | - |
`stores` | Contains the zustand state stores. For example the 'annotation' store holds the state for drawn annotations and edit history.
`hooks` | Contains various react hooks which provide reusable component functionality. For example the 'use-export' hook file contains functionality to export and download generated images in the two apps.
`components` | Contains the various preact components use to render pages. Some components comprise of a single file while others are inside a folder. Components inside folders are usually accessed via an `index.tsx` file.
`misc` | Contains miscellaneous stuff like types and constants.

There are also some similar components in each app.

Core file | Pretty Background | Pretty Annotate
| :-: | :-: | :-: |
Compositor | [file link](src/pretty-background/components/compositor/index.tsx) | [file link](src/pretty-annotate/components/compositor/index.tsx)
Controls | [file link](src/pretty-background/components/controls/index.tsx) | [file link](src/pretty-annotate/components/controls/index.tsx)
Store | [file link](src/pretty-background/stores/options.ts) | [file link](src/pretty-annotate/stores/annotation.ts)

---

### Image import/export

Both Pretty Snap apps require importing a screenshot, manipulating it somehow, then exporting it.

#### Import

Images are imported via file selection, pasting from clipboard, or dragging and dropping an image on the page. See the [`use-import.ts`](src/common/hooks/use-import.ts) hook for how this is done.

#### Image Edits

The specifics of image manipulation depends on the app but here are some common concepts:
- An app displays an interactive component allowing the user to manipulate their screenshot in some way. These are termed '**compositor**' components in code.
- All manipulations are rendered via standard HTML, SVG, and CSS elements. No JS canvas is used so that we can make full use of the various JS and CSS libraries without having to write custom rendering logic.
- Each app must maintain an additional 'render element' which is invisible to the user. This element renders everything that will be exported to the image. It may differ slightly from the visible compositor e.g. the annotate image doesn't render the resize UI.
- Edits are stored via zustand '**stores**' which allows components to update themselves based on option changes.
- Options are updated by the users using various '**controls**' such as buttons, toggles, images etc.

#### Export

To export an image we use the `dom-to-image` library to transform the HTML and CSS of the 'render element' into a png image. The render element is scale up to the target resolution (around the same size as the import image) so the image is not limited by the screen size of the user's device.

---

### [Pretty Background](src/pretty-background)

This app allows you to add pretty background patterns or images to screenshots. Some key features are:
- Select a pattern and adjust its colour and style
- Search and select an image from the Unsplash API
- Update the image size and position relative to the background

Some interesting code details:
- Patterns are [dynamic SVG strings](src/pretty-background/data/patterns.ts) that can be used as CSS `background-image` properties. By defining them as SVG strings we can change the size and colours dynamically according to the chosen settings.
- The main [compositor hook](src/pretty-background/components/compositor/use-comp-styles.ts) outputs the CSS styles for both the visible and render elements. It must scale the padding and position appropriately because the visible component must shrink in order to fix on screen and match the rendered image.

---

### [Pretty Annotate](src/pretty-annotate)

This app allows you to annotation screenshots with text and shapes. Some key features are:
- Select various shapes, text, and colours
- Drag them onto the image to annotate stuff
- Undo/redo edits
- Move/resize/delete shapes

Some interesting code details:
- All shapes are drawn using common [box 'bounds'](src/pretty-annotate/misc/types.ts) which define the position and size of the drawn area. This allows the shape [viewer and editor](src/pretty-annotate/components/compositor/editor.tsx)  to remain shape agnostic and keeps the [store](src/pretty-annotate/stores/annotation.ts) fairly simple too.
- Annotations are defined as modular components and are [rendered here](src/pretty-annotate/components/annotations/index.tsx) according on their type. The component simply require the 'bounds' and 'style' objects to render themselves.
- All elements support a dashed line version which are updated on the fly to fit the drawn shape perfectly. Changes in dash length are [animated smoothly](src/pretty-annotate/hooks/use-dash.ts) via react-spring.
